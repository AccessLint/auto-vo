#!/bin/sh

set -e

# Turn off splash screen
/usr/libexec/PlistBuddy -c "Set :doNotShowSplashScreen YES" \
  ~/Library/Preferences/com.apple.VoiceOverTraining.plist || \
  /usr/libexec/PlistBuddy -c "Add :doNotShowSplashScreen bool YES" \
  ~/Library/Preferences/com.apple.VoiceOverTraining.plist

# open "$1" -a Safari

sleep 3

open -a "VoiceOver Utility"

sleep 5

# send key events to check VoiceOver applescript enablement and enter password

screencapture ~/Desktop/1.png
echo "enable applescript"
osascript -e 'tell application "System Events"' \
 -e "key code 48" \
 -e "key code 48" \
 -e "key code 48" \
 -e "key code 48" \
 -e "key code 48" \
 -e "key code 48" \
 -e "key code 48" \
 -e "key code 48" \
 -e "key code 48" \
 -e "key code 48" \
 -e "key code 48" \
 -e "key code 48" \
 -e "key code 48" \
 -e "key code 49" \
 -e "key code 36" \
 -e "key code 36" \
 -e "key code 48" \
 -e "end tell"

sleep 60

screencapture ~/Desktop/2.png

echo "confirmation"
osascript -e 'tell application "System Events"' \
 -e 'tell window 1 of process "SecurityAgent"' \
 -e 'tell scroll area 1 of group 1' \
 -e 'set value of text field 1 to "voiceover"' \
 -e "set value of text field 2 to \"$AUTO_VO_PASSWORD\""  \
 -e "end tell" \
 -e "end tell" \
 -e "end tell"
echo "end confirmation"
screencapture ~/Desktop/3.png

# start VoiceOver
/System/Library/CoreServices/VoiceOver.app/Contents/MacOS/VoiceOverStarter

sleep 1

echo "Copy phrase"
osascript -e 'tell application "VoiceOver"' \
  -e "copy to pasteboard last phrase" \
  -e "grab screenshot vo cursor" \
  -e "end tell"

expected="$2"
actual="$(pbpaste)"

echo $actual

if [[ "$actual" =~ .*"$expected".* ]]; then
  echo "üëç passed assertion"
else
  echo "‚ùåfailed 1 assertion. Expected \"$expected\" in \"$actual\""
fi
