#!/bin/sh

set -e

echo "Need root to temporarily override VoiceOver launch settings"

# temporarily set VoiceOver daemon launch arguments
# -p -- skip splash screen
# -t appname -- limit VoiceOver activity to target app
sudo launchctl debug gui/$UID/com.apple.VoiceOver -- \
  "/System/Library/CoreServices/VoiceOver.app/Contents/MacOS/VoiceOver" \
  -p \
  -t "$@" \
  launchd -s

# start VoiceOver
/System/Library/CoreServices/VoiceOver.app/Contents/MacOS/VoiceOverStarter &

open -a "$@"

sleep 5

osascript -e 'tell application "VoiceOver" to copy to pasteboard last phrase'

expected="Welcome to macOS. VoiceOver is on. Safari Favorites window toolbar"
actual="$(pbpaste)"

test "$expected" = "$actual" && echo "passed 1 assertion" || echo "failed 1 assertion. Expected $expected, got $actual"

kill "$(pidof VoiceOver)"
